# Testing overview: Smart Money Concepts

This document describes how the **smartmoneyconcepts** project tests its indicators and how you can run or extend the tests.

---

## Summary

| Aspect | Approach |
|--------|----------|
| **Framework** | Python standard library `unittest` |
| **Strategy** | Golden-file (snapshot) regression: run each indicator on fixed OHLCV data and compare output to saved CSV baselines |
| **CI** | GitHub Actions on every pull request: install package, run `tests/unit_tests.py` |
| **Test data** | Single instrument (EURUSD), 15-minute bars, under `tests/test_data/EURUSD/` |

---

## Test layout

```
tests/
├── unit_tests.py              # All automated tests
├── generate_gif.py            # Visual/validation script (not in CI)
├── test.gif                   # Output of generate_gif (optional)
└── test_data/
    └── EURUSD/
        ├── EURUSD_15M.csv     # Input OHLCV (single source of truth)
        ├── fvg_result_data.csv
        ├── fvg_consecutive_result_data.csv
        ├── swing_highs_lows_result_data.csv
        ├── bos_choch_result_data.csv
        ├── ob_result_data.csv
        ├── liquidity_result_data.csv
        ├── previous_high_low_result_data_4h.csv
        ├── previous_high_low_result_data_1D.csv
        ├── previous_high_low_result_data_W.csv
        ├── sessions_result_data.csv
        └── retracements_result_data.csv
```

- **Input:** One CSV, `EURUSD_15M.csv`, with columns such as Date, Open, High, Low, Close, Volume (and optional Tickvol/Spread). The test suite loads it, sets `Date` as the index, and uses it for every indicator test.
- **Expected outputs:** One (or more) CSV per indicator. Each test runs the corresponding `smc` function and compares the returned DataFrame to the matching "result" CSV using `pd.testing.assert_frame_equal(..., check_dtype=False)`.

---

## How tests work

1. **Setup**
   - `unit_tests.py` adds the project root to `sys.path` and imports `smartmoneyconcepts.smc`.
   - It loads `EURUSD_15M.csv` into a DataFrame and sets the index to `Date` (datetime).

2. **Per-indicator tests**
   - Each test method:
     - Calls the relevant `smc` function (e.g. `smc.fvg(df)` or `smc.fvg(df, join_consecutive=True)`).
     - Loads the corresponding expected CSV from `test_data/EURUSD/`.
     - Uses `pd.testing.assert_frame_equal(actual, expected, check_dtype=False)` so that the current run must match the saved baseline exactly (except dtypes).
   - Optional: test methods also print elapsed time for a rough performance check.

3. **Edge-case test**
   - `test_ob_early_data` does **not** use a golden file. It builds a small DataFrame (3 rows), runs `swing_highs_lows` and `ob`, and asserts that the result length equals the input length. This guards against index/length errors on short series.

4. **Multi-variant tests**
   - `test_previous_high_low` runs the same indicator three times with `time_frame="4h"`, `"1D"`, and `"W"`, each time comparing against its own result CSV.

So the main approach is: **deterministic indicators + fixed input CSV → compare full output to committed result CSVs**. Any change in indicator logic that changes the output will fail the test until the baseline is intentionally updated.

---

## Running tests locally

From the project root:

```bash
pip install .
cd tests
python unit_tests.py
```

Or, with verbose output:

```bash
cd tests
python unit_tests.py -v
```

The GitHub Actions workflow does the same: checkout, setup Python 3.8, `pip install .`, then run `python unit_tests.py` from the `tests/` directory.

---

## Updating baselines (golden files)

Expected result CSVs were generated by running the indicators and writing the outputs to CSV (see the commented block at the bottom of `unit_tests.py`). To refresh baselines after an intentional change in behavior:

1. Uncomment and run the `generate_results_data()`-style code (or equivalent) so it writes the new outputs into `tests/test_data/EURUSD/`.
2. Run `python unit_tests.py` to confirm all tests pass.
3. Commit the updated `*_result_data.csv` files.

Only do this when you have deliberately changed indicator logic and want the new behavior to become the new baseline.

---

## What is not in the test suite

- **generate_gif.py** – Uses Plotly and (optionally) Binance to visualize FVGs and other concepts. It is for manual or local visual validation, not for CI. It is not run by `unit_tests.py`.
- **Other instruments/timeframes** – All tests use the single EURUSD 15M dataset. Other pairs or timeframes are not automatically tested.
- **Unit tests for pure helpers** – There are no separate tests for low-level helpers; coverage is via the main indicator APIs and their golden outputs.
- **Property-based or stochastic tests** – Tests are deterministic and snapshot-based only.

---

## Design choices in short

- **Golden-file regression:** Keeps tests simple and catches any change in indicator output. Trade-off: baseline updates require care and must be done explicitly.
- **Single shared input:** One OHLCV file keeps the test environment predictable and avoids duplication; all indicators are validated on the same market slice.
- **DataFrame equality:** `assert_frame_equal` with `check_dtype=False` focuses on values and structure; dtypes can differ (e.g. int vs float) without failing.
- **stdlib unittest:** No extra test dependencies; easy to run in CI and on any machine with the project's `pip install .` dependencies.

---

## Quick reference: test ↔ indicator

| Test method | smc API used | Expected data file(s) |
|-------------|--------------|------------------------|
| `test_fvg` | `smc.fvg(df)` | `fvg_result_data.csv` |
| `test_fvg_consecutive` | `smc.fvg(df, join_consecutive=True)` | `fvg_consecutive_result_data.csv` |
| `test_swing_highs_lows` | `smc.swing_highs_lows(df, swing_length=5)` | `swing_highs_lows_result_data.csv` |
| `test_bos_choch` | `smc.swing_highs_lows` + `smc.bos_choch` | `bos_choch_result_data.csv` |
| `test_ob` | `smc.swing_highs_lows` + `smc.ob` | `ob_result_data.csv` |
| `test_ob_early_data` | `smc.swing_highs_lows` + `smc.ob` (short df) | (inline assertion, no file) |
| `test_liquidity` | `smc.swing_highs_lows` + `smc.liquidity` | `liquidity_result_data.csv` |
| `test_previous_high_low` | `smc.previous_high_low(df, time_frame=…)` | `previous_high_low_result_data_4h.csv`, `_1D.csv`, `_W.csv` |
| `test_sessions` | `smc.sessions(df, session="London")` | `sessions_result_data.csv` |
| `test_retracements` | `smc.swing_highs_lows` + `smc.retracements` | `retracements_result_data.csv` |
